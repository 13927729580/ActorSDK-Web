{"version":3,"sources":["../../src/components/Dialog.react.js"],"names":[],"mappings":"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","file":"Dialog.react.js","sourcesContent":["/*\n * Copyright (C) 2015-2016 Actor LLC. <https://actor.im>\n */\n\nimport { debounce, map, isFunction } from 'lodash';\n\nimport React, { Component, PropTypes } from 'react';\nimport { findDOMNode } from 'react-dom';\nimport PeerUtils from '../utils/PeerUtils';\n\nimport DefaultMessages from './dialog/MessagesSection.react';\nimport DefaultTyping from './dialog/TypingSection.react';\nimport DefaultCompose from './dialog/ComposeSection.react';\nimport DialogFooter from './dialog/DialogFooter.react';\nimport DefaultToolbar from './Toolbar.react';\nimport DefaultActivity from './Activity.react';\nimport DefaultCall from './Call.react';\nimport ConnectionState from './common/ConnectionState.react';\n\nimport ActivityStore from '../stores/ActivityStore';\nimport DialogStore from '../stores/DialogStore';\nimport MessageStore from '../stores/MessageStore';\n\nimport DialogActionCreators from '../actions/DialogActionCreators';\n\n// On which scrollTop value start loading older messages\nconst loadMessagesScrollTop = 100;\nconst initialRenderMessagesCount = 20;\nconst renderMessagesStep = 20;\n\nlet renderMessagesCount = initialRenderMessagesCount;\nlet lastScrolledFromBottom = 0;\n\nconst getStateFromStores = () => {\n  const messages = MessageStore.getAll();\n  const overlay = MessageStore.getOverlay();\n  const messagesToRender = (messages.length > renderMessagesCount) ? messages.slice(messages.length - renderMessagesCount) : messages;\n  const overlayToRender = (overlay.length > renderMessagesCount) ? overlay.slice(overlay.length - renderMessagesCount) : overlay;\n\n  return {\n    peer: DialogStore.getCurrentPeer(),\n    messages,\n    overlay,\n    messagesToRender,\n    overlayToRender,\n    isMember: DialogStore.isMember()\n  };\n};\n\nclass DialogSection extends Component {\n  static contextTypes = {\n    delegate: PropTypes.object\n  };\n\n  static propTypes = {\n    params: PropTypes.object\n  };\n\n  constructor(props) {\n    super(props);\n\n    this.state = getStateFromStores();\n\n    ActivityStore.addListener(this.fixScrollTimeout);\n    MessageStore.addListener(this.onMessagesChange);\n    DialogStore.addListener(this.onChange);\n  }\n\n  componentWillMount() {\n    const peer = PeerUtils.stringToPeer(this.props.params.id);\n    DialogActionCreators.selectDialogPeer(peer);\n  }\n\n  componentDidMount() {\n    const peer = PeerUtils.stringToPeer(this.props.params.id);\n    if (peer) {\n      this.fixScroll();\n      this.loadMessagesByScroll();\n    }\n  }\n\n  componentWillReceiveProps(nextProps) {\n    const { params } = nextProps;\n    if (this.props.params.id !== params.id) {\n      const peer = PeerUtils.stringToPeer(params.id);\n      DialogActionCreators.selectDialogPeer(peer);\n      if (peer) {\n        this.fixScroll();\n        this.loadMessagesByScroll();\n      }\n    }\n  }\n\n  componentDidUpdate() {\n    this.fixScroll();\n  }\n\n  componentWillUnmount() {\n    DialogActionCreators.selectDialogPeer(null);\n  }\n\n  fixScrollTimeout = () => {\n    setTimeout(this.fixScroll, 50);\n  };\n\n  getScrollArea() {\n    const scrollNode = findDOMNode(this.refs.messagesSection.refs.messagesScroll.refs.scroll);\n    return scrollNode.getElementsByClassName('ss-scrollarea')[0];\n  }\n\n  fixScroll = () => {\n    const node = this.getScrollArea();\n    if (node) {\n      node.scrollTop = node.scrollHeight - lastScrolledFromBottom - node.offsetHeight;\n    }\n  };\n\n  onChange = () => {\n    lastScrolledFromBottom = 0;\n    renderMessagesCount = initialRenderMessagesCount;\n    this.setState(getStateFromStores());\n  };\n\n  onMessagesChange = debounce(() => {\n    this.setState(getStateFromStores());\n  }, 10, {maxWait: 50, leading: true});\n\n  loadMessagesByScroll = debounce(() => {\n    const { peer, messages, messagesToRender } = this.state;\n\n    if (peer) {\n      const node = this.getScrollArea();\n      let scrollTop = node.scrollTop;\n      lastScrolledFromBottom = node.scrollHeight - scrollTop - node.offsetHeight; // was node.scrollHeight - scrollTop\n\n      if (node.scrollTop < loadMessagesScrollTop) {\n\n        if (messages.length > messagesToRender.length) {\n          renderMessagesCount += renderMessagesStep;\n\n          if (renderMessagesCount > messages.length) {\n            renderMessagesCount = messages.length;\n          }\n\n          this.setState(getStateFromStores());\n        } else {\n            DialogActionCreators.onChatEnd(peer);\n        }\n      }\n    }\n  }, 5, {maxWait: 30});\n\n  getComponents() {\n    const {dialog} = this.context.delegate.components;\n    if (dialog && !isFunction(dialog)) {\n      const activity = dialog.activity || [\n        DefaultActivity,\n        DefaultCall\n      ];\n\n      return {\n        ToolbarSection: dialog.toolbar || DefaultToolbar,\n        MessagesSection: isFunction(dialog.messages) ? dialog.messages : DefaultMessages,\n        TypingSection: dialog.typing || DefaultTyping,\n        ComposeSection: dialog.compose || DefaultCompose,\n        activity: map(activity, (Activity, index) => <Activity key={index} />)\n      };\n    }\n\n    return {\n      ToolbarSection: DefaultToolbar,\n      MessagesSection: DefaultMessages,\n      TypingSection: DefaultTyping,\n      ComposeSection: DefaultCompose,\n      activity: [\n        <DefaultActivity key={1} />,\n        <DefaultCall key={2} />\n      ]\n    };\n  }\n\n  render() {\n    const { peer, isMember, messagesToRender, overlayToRender } = this.state;\n\n    const {\n      ToolbarSection,\n      MessagesSection,\n      TypingSection,\n      ComposeSection,\n      activity\n    } = this.getComponents();\n\n    return (\n      <section className=\"main\">\n        <ToolbarSection />\n        <div className=\"flexrow\">\n          <section className=\"dialog\">\n            <ConnectionState/>\n            <div className=\"messages\">\n              <MessagesSection\n                messages={messagesToRender}\n                overlay={overlayToRender}\n                peer={peer}\n                ref=\"messagesSection\"\n                onScroll={this.loadMessagesByScroll}\n              />\n            </div>\n            <DialogFooter isMember={isMember} components={{TypingSection, ComposeSection}} />\n          </section>\n          {activity}\n        </div>\n      </section>\n    );\n  }\n}\n\nexport default DialogSection;\n"]}