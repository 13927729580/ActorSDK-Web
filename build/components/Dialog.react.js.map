{"version":3,"sources":["../../src/components/Dialog.react.js"],"names":[],"mappings":"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","file":"Dialog.react.js","sourcesContent":["/*\n * Copyright (C) 2015-2016 Actor LLC. <https://actor.im>\n */\n\nimport { debounce, map, isFunction } from 'lodash';\n\nimport React, { Component, PropTypes } from 'react';\nimport { Container } from 'flux/utils';\nimport { findDOMNode } from 'react-dom';\nimport PeerUtils from '../utils/PeerUtils';\n\nimport DefaultMessages from './dialog/MessagesSection.react';\nimport DefaultTyping from './dialog/TypingSection.react';\nimport DefaultCompose from './dialog/ComposeSection.react';\nimport DialogFooter from './dialog/DialogFooter.react';\nimport DefaultToolbar from './Toolbar.react';\nimport DefaultActivity from './Activity.react';\nimport DefaultCall from './Call.react';\nimport DefaultLogger from './dev/LoggerSection.react';\nimport ConnectionState from './common/ConnectionState.react';\n\nimport ActivityStore from '../stores/ActivityStore';\nimport DialogStore from '../stores/DialogStore';\nimport MessageStore from '../stores/MessageStore';\n\nimport DialogActionCreators from '../actions/DialogActionCreators';\n\n// On which scrollTop value start loading older messages\nconst loadMessagesScrollTop = 100;\n\nlet lastScrolledFromBottom = 0;\n\nclass DialogSection extends Component {\n  static contextTypes = {\n    delegate: PropTypes.object\n  };\n\n  static propTypes = {\n    params: PropTypes.object\n  };\n\n  static getStores() {\n    return [ActivityStore, MessageStore, DialogStore]\n  }\n\n  static calculateState() {\n    return {\n      peer: DialogStore.getCurrentPeer(),\n      isMember: DialogStore.isMember(),\n      messages: MessageStore.getMessagesToRender(),\n      overlay: MessageStore.getOverlayToRender(),\n      isActivityOpen: ActivityStore.isOpen()\n    };\n  }\n\n  constructor(props) {\n    super(props);\n\n    const peer = PeerUtils.stringToPeer(props.params.id);\n    DialogActionCreators.selectDialogPeer(peer);\n  }\n\n  componentDidMount() {\n    const { peer } = this.state;\n    if (peer) {\n      this.fixScroll();\n      this.loadMessagesByScroll();\n    }\n  }\n\n  componentWillReceiveProps(nextProps) {\n    const { params } = nextProps;\n    if (this.props.params.id !== params.id) {\n      const peer = PeerUtils.stringToPeer(params.id);\n      DialogActionCreators.selectDialogPeer(peer);\n      lastScrolledFromBottom = 0;\n      if (peer) {\n        this.fixScroll();\n        this.loadMessagesByScroll();\n      }\n    }\n  }\n\n  componentDidUpdate(prevProps, prevState) {\n    if (prevState.isActivityOpen !== this.state.isActivityOpen) {\n      this.fixScrollTimeout();\n    } else {\n      this.fixScroll();\n    }\n  }\n\n  componentWillUnmount() {\n    // Unbind from current peer\n    DialogActionCreators.selectDialogPeer(null);\n  }\n\n  getScrollArea() {\n    const scrollNode = findDOMNode(this.refs.messagesSection.refs.messagesScroll.refs.scroll);\n    return scrollNode.getElementsByClassName('ss-scrollarea')[0];\n  }\n\n  fixScroll = () => {\n    const node = this.getScrollArea();\n    if (node) {\n      node.scrollTop = node.scrollHeight - lastScrolledFromBottom - node.offsetHeight;\n    }\n  };\n\n  fixScrollTimeout = () => {\n    setTimeout(this.fixScroll, 50);\n  };\n\n  loadMessagesByScroll = debounce(() => {\n    const { peer } = this.state;\n\n    if (peer) {\n      const node = this.getScrollArea();\n      lastScrolledFromBottom = node.scrollHeight - node.scrollTop - node.offsetHeight;\n\n      if (node.scrollTop < loadMessagesScrollTop) DialogActionCreators.loadMoreMessages(peer);\n    }\n  }, 5, {maxWait: 30});\n\n  getComponents() {\n    const { dialog, logger } = this.context.delegate.components;\n    const LoggerSection = logger || DefaultLogger;\n    if (dialog && !isFunction(dialog)) {\n      const activity = dialog.activity || [\n        DefaultActivity,\n        DefaultCall,\n        LoggerSection\n      ];\n\n      return {\n        LoggerSection,\n        ToolbarSection: dialog.toolbar || DefaultToolbar,\n        MessagesSection: isFunction(dialog.messages) ? dialog.messages : DefaultMessages,\n        TypingSection: dialog.typing || DefaultTyping,\n        ComposeSection: dialog.compose || DefaultCompose,\n        activity: map(activity, (Activity, index) => <Activity key={index} />)\n      };\n    }\n\n    return {\n      LoggerSection,\n      ToolbarSection: DefaultToolbar,\n      MessagesSection: DefaultMessages,\n      TypingSection: DefaultTyping,\n      ComposeSection: DefaultCompose,\n      activity: [\n        <DefaultActivity key={1} />,\n        <DefaultCall key={2} />,\n        <LoggerSection key={3} />\n      ]\n    };\n  }\n\n  render() {\n    const { peer, isMember, messages, overlay } = this.state;\n\n    const {\n      ToolbarSection,\n      MessagesSection,\n      TypingSection,\n      ComposeSection,\n      activity\n    } = this.getComponents();\n\n    return (\n      <section className=\"main\">\n        <ToolbarSection />\n        <div className=\"flexrow\">\n          <section className=\"dialog\">\n            <ConnectionState/>\n            <div className=\"messages\">\n              <MessagesSection\n                isMember={isMember}\n                messages={messages}\n                overlay={overlay}\n                peer={peer}\n                ref=\"messagesSection\"\n                onScroll={this.loadMessagesByScroll}\n              />\n            </div>\n            <DialogFooter isMember={isMember} components={{TypingSection, ComposeSection}} />\n          </section>\n          {activity}\n        </div>\n      </section>\n    );\n  }\n}\n\nexport default Container.create(DialogSection);\n"]}