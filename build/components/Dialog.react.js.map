{"version":3,"sources":["../../src/components/Dialog.react.js"],"names":[],"mappings":"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","file":"Dialog.react.js","sourcesContent":["/*\n * Copyright (C) 2015-2016 Actor LLC. <https://actor.im>\n */\n\nimport { debounce, forEach } from 'lodash';\n\nimport React, { Component, PropTypes } from 'react';\nimport { findDOMNode } from 'react-dom';\nimport PeerUtils from '../utils/PeerUtils';\n\nimport DefaultMessagesSection from './dialog/MessagesSection.react';\nimport DefaultTypingSection from './dialog/TypingSection.react';\nimport DefaultComposeSection from './dialog/ComposeSection.react';\nimport DefaultToolbarSection from './Toolbar.react';\nimport DefaultActivitySection from './Activity.react';\nimport DefaultEmptyScreen from './common/EmptyScreen.react';\nimport ConnectionState from './common/ConnectionState.react';\n\nimport ActivityStore from '../stores/ActivityStore';\nimport DialogStore from '../stores/DialogStore';\nimport MessageStore from '../stores/MessageStore';\n\nimport DialogActionCreators from '../actions/DialogActionCreators';\n\n// On which scrollTop value start loading older messages\nconst loadMessagesScrollTop = 100;\nconst initialRenderMessagesCount = 20;\nconst renderMessagesStep = 20;\n\nlet renderMessagesCount = initialRenderMessagesCount;\nlet lastScrolledFromBottom = 0;\n\nconst getStateFromStores = () => {\n  const messages = MessageStore.getAll();\n  const overlay = MessageStore.getOverlay();\n  const messagesToRender = (messages.length > renderMessagesCount) ? messages.slice(messages.length - renderMessagesCount) : messages;\n  const overlayToRender = (overlay.length > renderMessagesCount) ? overlay.slice(overlay.length - renderMessagesCount) : overlay;\n\n  return {\n    peer: DialogStore.getCurrentPeer(),\n    messages,\n    overlay,\n    messagesToRender,\n    overlayToRender,\n    isMember: DialogStore.isMember()\n  };\n};\n\nclass DialogSection extends Component {\n  static contextTypes = {\n    delegate: PropTypes.object\n  };\n\n  static propTypes = {\n    params: PropTypes.object\n  };\n\n  constructor(props) {\n    super(props);\n\n    this.state = getStateFromStores();\n\n    ActivityStore.addListener(this.fixScrollTimeout);\n    MessageStore.addListener(this.onMessagesChange);\n    DialogStore.addListener(this.onChange);\n  }\n\n  componentWillMount() {\n    const peer = PeerUtils.stringToPeer(this.props.params.id);\n    DialogActionCreators.selectDialogPeer(peer);\n  }\n\n  componentDidMount() {\n    const peer = PeerUtils.stringToPeer(this.props.params.id);\n    if (peer) {\n      this.fixScroll();\n      this.loadMessagesByScroll();\n    }\n  }\n\n  componentWillReceiveProps(nextProps) {\n    const { params } = nextProps;\n    if (this.props.params.id !== params.id) {\n      const peer = PeerUtils.stringToPeer(params.id);\n      DialogActionCreators.selectDialogPeer(peer);\n      if (peer) {\n        this.fixScroll();\n        this.loadMessagesByScroll();\n      }\n    }\n  }\n\n  componentWillUnmount() {\n    DialogActionCreators.selectDialogPeer(null);\n  }\n\n  fixScrollTimeout = () => {\n    setTimeout(this.fixScroll, 50);\n  };\n\n  fixScroll = () => {\n    const scrollNode = findDOMNode(this.refs.messagesSection.refs.messagesScroll.refs.scroll);\n    const node = scrollNode.getElementsByClassName('ss-scrollarea')[0];\n    if (node) {\n      node.scrollTop = node.scrollHeight - lastScrolledFromBottom - node.offsetHeight;\n    }\n  };\n\n  onChange = () => {\n    lastScrolledFromBottom = 0;\n    renderMessagesCount = initialRenderMessagesCount;\n    this.setState(getStateFromStores());\n  };\n\n  onMessagesChange = debounce(() => {\n    this.setState(getStateFromStores());\n  }, 10, {maxWait: 50, leading: true});\n\n  loadMessagesByScroll = debounce(() => {\n    const { peer, messages, messagesToRender } = this.state;\n\n    if (peer) {\n      const scrollNode = findDOMNode(this.refs.messagesSection.refs.messagesScroll.refs.scroll);\n      const node = scrollNode.getElementsByClassName('ss-scrollarea')[0];\n      let scrollTop = node.scrollTop;\n      lastScrolledFromBottom = node.scrollHeight - scrollTop - node.offsetHeight; // was node.scrollHeight - scrollTop\n\n      if (node.scrollTop < loadMessagesScrollTop) {\n\n        if (messages.length > messagesToRender.length) {\n          renderMessagesCount += renderMessagesStep;\n\n          if (renderMessagesCount > messages.length) {\n            renderMessagesCount = messages.length;\n          }\n\n          this.setState(getStateFromStores());\n        } else {\n            DialogActionCreators.onChatEnd(peer);\n        }\n      }\n    }\n  }, 5, {maxWait: 30});\n\n\n  render() {\n    const { peer, isMember, messagesToRender, overlayToRender } = this.state;\n    const { delegate } = this.context;\n\n    let activity = [],\n        ToolbarSection,\n        TypingSection,\n        ComposeSection,\n        MessagesSection,\n        EmptyScreen;\n\n    if (delegate.components.dialog !== null && typeof delegate.components.dialog !== 'function') {\n      ToolbarSection = delegate.components.dialog.toolbar || DefaultToolbarSection;\n      MessagesSection = (typeof delegate.components.dialog.messages == 'function') ? delegate.components.dialog.messages : DefaultMessagesSection;\n      TypingSection = delegate.components.dialog.typing || DefaultTypingSection;\n      ComposeSection = delegate.components.dialog.compose || DefaultComposeSection;\n      EmptyScreen = delegate.components.dialog.empty || DefaultEmptyScreen;\n\n      if (delegate.components.dialog.activity) {\n        forEach(delegate.components.dialog.activity, (Activity, index) => activity.push(<Activity key={index}/>));\n      } else {\n        activity.push(<DefaultActivitySection key={1}/>);\n      }\n    } else {\n      ToolbarSection = DefaultToolbarSection;\n      MessagesSection = DefaultMessagesSection;\n      TypingSection = DefaultTypingSection;\n      ComposeSection = DefaultComposeSection;\n      EmptyScreen = DefaultEmptyScreen;\n      activity.push(<DefaultActivitySection key={1}/>);\n    }\n\n    const mainScreen = peer ? (\n      <section className=\"dialog\" key={0}>\n        <ConnectionState/>\n        <div className=\"messages\">\n          <MessagesSection messages={messagesToRender}\n                           overlay={overlayToRender}\n                           peer={peer}\n                           ref=\"messagesSection\"\n                           onScroll={this.loadMessagesByScroll}/>\n\n        </div>\n        {\n          isMember\n            ? <footer className=\"dialog__footer\">\n                <TypingSection/>\n                <ComposeSection/>\n              </footer>\n            : <footer className=\"dialog__footer dialog__footer--disabled row center-xs middle-xs \">\n                <h3>You are not a member</h3>\n              </footer>\n        }\n      </section>\n    ) : null;\n\n    return (\n      <section className=\"main\">\n        <ToolbarSection/>\n        <div className=\"flexrow\">\n          {mainScreen}\n          {activity}\n        </div>\n      </section>\n    );\n  }\n}\n\nexport default DialogSection;\n"]}