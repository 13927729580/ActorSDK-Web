{"version":3,"sources":["../../src/components/DialogSection.react.js"],"names":[],"mappings":"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","file":"DialogSection.react.js","sourcesContent":["/*\n * Copyright (C) 2015 Actor LLC. <https://actor.im>\n */\n\nimport React, { Component, PropTypes } from 'react';\nimport { debounce, forEach } from 'lodash';\n\nimport { PeerTypes } from '../constants/ActorAppConstants';\n\nimport PeerUtils from '../utils/PeerUtils';\n\nimport MessagesSection from './dialog/MessagesSection.react';\nimport DefaultTypingSection from './dialog/TypingSection.react';\nimport DefaultComposeSection from './dialog/ComposeSection.react';\nimport DefaultToolbarSection from './ToolbarSection.react';\nimport DefaultActivitySection from './ActivitySection.react';\nimport ConnectionState from './common/ConnectionState.react';\n\nimport ActivityStore from '../stores/ActivityStore';\nimport DialogStore from '../stores/DialogStore';\nimport MessageStore from '../stores/MessageStore';\nimport GroupStore from '../stores/GroupStore';\n\nimport DialogActionCreators from '../actions/DialogActionCreators';\n\n// On which scrollTop value start loading older messages\nconst loadMessagesScrollTop = 100;\nconst initialRenderMessagesCount = 20;\nconst renderMessagesStep = 20;\n\nlet renderMessagesCount = initialRenderMessagesCount;\nlet lastScrolledFromBottom = 0;\n\nconst getStateFromStores = () => {\n  const messages = MessageStore.getAll();\n  const messagesToRender = (messages.length > renderMessagesCount) ? messages.slice(messages.length - renderMessagesCount) : messages;\n\n  return {\n    peer: DialogStore.getCurrentPeer(),\n    messages,\n    messagesToRender,\n    isMember: DialogStore.isMember()\n  };\n};\n\nclass DialogSection extends Component {\n  static contextTypes = {\n    delegate: PropTypes.object\n  };\n\n  constructor(props) {\n    super(props);\n\n    this.state = getStateFromStores();\n\n    ActivityStore.addListener(this.fixScrollTimeout);\n    MessageStore.addListener(this.onMessagesChange);\n    DialogStore.addListener(this.onChange);\n  }\n\n  componentDidMount() {\n    const { peer } = this.state;\n\n    if (peer) {\n      this.fixScroll();\n      this.loadMessagesByScroll();\n    }\n  }\n\n  componentDidUpdate() {\n    this.fixScroll();\n    this.loadMessagesByScroll();\n  }\n\n  render() {\n    const { peer, isMember, messagesToRender } = this.state;\n    const { delegate } = this.context;\n\n    let activity = [],\n        ToolbarSection,\n        TypingSection,\n        ComposeSection;\n\n    if (delegate.components.dialog !== null && typeof delegate.components.dialog !== 'function') {\n      ToolbarSection = delegate.components.dialog.toolbar || DefaultToolbarSection;\n      TypingSection = delegate.components.dialog.typing || DefaultTypingSection;\n      ComposeSection = delegate.components.dialog.compose || DefaultComposeSection;\n\n      if (delegate.components.dialog.activity) {\n        forEach(delegate.components.dialog.activity, (Activity) => activity.push(<Activity/>));\n      } else {\n        activity.push(<DefaultActivitySection/>);\n      }\n    } else {\n      ToolbarSection = DefaultToolbarSection;\n      TypingSection = DefaultTypingSection;\n      ComposeSection = DefaultComposeSection;\n      activity.push(<DefaultActivitySection/>);\n    }\n\n    const mainScreen = (\n      <section className=\"dialog\">\n        <ConnectionState/>\n        <div className=\"messages\">\n          <MessagesSection messages={messagesToRender}\n                           peer={peer}\n                           ref=\"MessagesSection\"\n                           onScroll={this.loadMessagesByScroll}/>\n\n        </div>\n        {\n          isMember\n            ? <footer className=\"dialog__footer\">\n                <TypingSection/>\n                <ComposeSection peer={peer}/>\n              </footer>\n            : <footer className=\"dialog__footer dialog__footer--disabled row center-xs middle-xs \">\n                <h3>You are not a member</h3>\n              </footer>\n        }\n      </section>\n    );\n    const emptyScreen = (\n      <section className=\"dialog dialog--empty row center-xs middle-xs\">\n        <ConnectionState/>\n\n        <div className=\"advice\">\n          <div className=\"actor-logo\">\n            <svg className=\"icon icon--gray\"\n                 dangerouslySetInnerHTML={{__html: '<use xlink:href=\"assets/images/icons.svg#star\"/>'}}/>\n          </div>\n          <h2>Try to be better than yesterday!</h2>\n        </div>\n      </section>\n    );\n\n    return (\n      <section className=\"main\">\n        <ToolbarSection/>\n\n        <div className=\"flexrow\">\n          {\n            peer\n              ? mainScreen\n              : emptyScreen\n          }\n          {activity}\n        </div>\n      </section>\n    );\n  }\n\n  fixScrollTimeout = () => {\n    setTimeout(this.fixScroll, 50);\n  };\n\n  fixScroll = () => {\n    const node = React.findDOMNode(this.refs.MessagesSection);\n    if (node) {\n      node.scrollTop = node.scrollHeight - lastScrolledFromBottom - node.offsetHeight;\n    }\n  };\n\n  onChange = () => {\n    lastScrolledFromBottom = 0;\n    renderMessagesCount = initialRenderMessagesCount;\n    this.setState(getStateFromStores());\n  };\n\n  onMessagesChange = debounce(() => {\n    this.setState(getStateFromStores());\n  }, 10, {maxWait: 50, leading: true});\n\n  loadMessagesByScroll = debounce(() => {\n    const { peer, messages, messagesToRender } = this.state;\n\n    if (peer) {\n      let node = React.findDOMNode(this.refs.MessagesSection);\n      let scrollTop = node.scrollTop;\n      lastScrolledFromBottom = node.scrollHeight - scrollTop - node.offsetHeight; // was node.scrollHeight - scrollTop\n\n      if (node.scrollTop < loadMessagesScrollTop) {\n        DialogActionCreators.onChatEnd(peer);\n\n        if (messages.length > messagesToRender.length) {\n          renderMessagesCount += renderMessagesStep;\n\n          if (renderMessagesCount > messages.length) {\n            renderMessagesCount = messages.length;\n          }\n\n          this.setState(getStateFromStores());\n        }\n      }\n    }\n  }, 5, {maxWait: 30});\n}\n\nexport default DialogSection;\n"]}