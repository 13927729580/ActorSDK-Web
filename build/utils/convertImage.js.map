{"version":3,"sources":["../../src/utils/convertImage.js"],"names":[],"mappings":"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","file":"convertImage.js","sourcesContent":["/* global WebPDecoder */\nimport { memoize } from 'lodash';\n\nfunction loadImage(src) {\n  return new Promise(function (resolve, reject) {\n    var xhr = new XMLHttpRequest();\n    if (xhr.overrideMimeType) {\n      xhr.overrideMimeType('text/plain; charset=x-user-defined');\n    } else {\n      xhr.setRequestHeader('Accept-Charset', 'x-user-defined');\n    }\n\n    xhr.addEventListener('error', reject);\n    xhr.addEventListener('load', function () {\n      var binary = xhr.responseText.split('').map(function (e) {\n        return String.fromCharCode(e.charCodeAt(0) & 0xff);\n      }).join('');\n      resolve(binary);\n    });\n\n    xhr.open('GET', src);\n    xhr.send();\n  });\n}\n\nfunction binaryToArray(binary) {\n  var result = new Array();\n  for (var i = 0; i < binary.length; i++) {\n    result.push(binary.charCodeAt(i));\n  }\n\n  return result;\n}\n\nfunction convertWebPText(data) {\n  var buff = binaryToArray(data);\n\n  var decoder = new WebPDecoder();\n  var config = decoder.WebPDecoderConfig;\n  var output_buffer = config.j;\n  var bitstream = config.input;\n\n  if (!decoder.WebPInitDecoderConfig(config)) {\n    throw new Error('Library version mismatch!');\n  }\n\n  var status = decoder.WebPGetFeatures(buff, buff.length, bitstream);\n  if (status !== 0) {\n    throw new Error('Unable to decode webp image!', status);\n  }\n\n  output_buffer.J = 4;\n  status = decoder.WebPDecode(buff, buff.length, config);\n\n  if (status != 0) {\n    throw new Error('WebP decoding failed.', status);\n  }\n\n  return {\n    bitmap: output_buffer.c.RGBA.ma,\n    height: output_buffer.height,\n    width: output_buffer.width\n  };\n}\n\nvar canvas = document.createElement('canvas');\nvar context = canvas.getContext('2d');\n\nfunction convertWebPToPNG(src) {\n  return loadImage(src).then(function (data) {\n    const webp = convertWebPText(data);\n    canvas.height = webp.height;\n    canvas.width = webp.width;\n\n    var output = context.createImageData(canvas.width, canvas.height);\n    var outputData = output.data;\n\n    for (var h = 0; h < webp.height; h++) {\n      for (var w = 0; w < webp.width; w++) {\n        outputData[0 + w * 4 + webp.width * 4 * h] = webp.bitmap[1 + w * 4 + webp.width * 4 * h];\n        outputData[1 + w * 4 + webp.width * 4 * h] = webp.bitmap[2 + w * 4 + webp.width * 4 * h];\n        outputData[2 + w * 4 + webp.width * 4 * h] = webp.bitmap[3 + w * 4 + webp.width * 4 * h];\n        outputData[3 + w * 4 + webp.width * 4 * h] = webp.bitmap[0 + w * 4 + webp.width * 4 * h];\n      }\n    }\n\n    context.putImageData(output, 0, 0);\n    return canvas.toDataURL();\n  })\n}\n\nconst isWebPSupported = new Promise((resolve) => {\n  var image = new Image();\n  image.onload = () => resolve(image.width === 2 && image.height === 1);\n  image.onerror = () => resolve(false);\n  image.src = 'data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAACyAgCdASoCAAEALmk0mk0iIiIiIgBoSygABc6zbAAA/v56QAAAAA==';\n}).then((isSupported) => {\n  if (isSupported) {\n    return true;\n  }\n\n  return new Promise((resolve) => {\n    require.ensure(['../vendor/libwebp-0.2.0.min'], (require) => {\n      require('../vendor/libwebp-0.2.0.min');\n      resolve(false);\n    });\n  });\n})\n\nfunction convertImage(src) {\n  return isWebPSupported.then((isSupported) => {\n    if (isSupported || !/\\.webp\\?/.test(src)) {\n      return src;\n    }\n\n    return convertWebPToPNG(src);\n  });\n}\n\nexport default memoize(convertImage);\n"]}