{"version":3,"sources":["../../src/utils/convertImage.js"],"names":[],"mappings":"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","file":"convertImage.js","sourcesContent":["/* global WebPDecoder */\nimport { memoize } from 'lodash';\n\nfunction loadImage(src) {\n  return new Promise(function (resolve, reject) {\n    var xhr = new XMLHttpRequest();\n    if (xhr.overrideMimeType) {\n      xhr.overrideMimeType('text/plain; charset=x-user-defined');\n    } else {\n      xhr.setRequestHeader('Accept-Charset', 'x-user-defined');\n    }\n\n    xhr.addEventListener('error', reject);\n    xhr.addEventListener('load', function () {\n      var binary = xhr.responseText.split('').map(function (e) {\n        return String.fromCharCode(e.charCodeAt(0) & 0xff);\n      }).join('');\n      resolve(binary);\n    });\n\n    xhr.open('GET', src);\n    xhr.send();\n  });\n}\n\nfunction binaryToArray(binary) {\n  var result = new Array();\n  for (var i = 0; i < binary.length; i++) {\n    result.push(binary.charCodeAt(i));\n  }\n\n  return result;\n}\n\nfunction convertWebPText(data) {\n  var buff = binaryToArray(data);\n\n  var decoder = new WebPDecoder();\n  var config = decoder.WebPDecoderConfig;\n  var output_buffer = config.j;\n  var bitstream = config.input;\n\n  if (!decoder.WebPInitDecoderConfig(config)) {\n    throw new Error('Library version mismatch!');\n  }\n\n  var status = decoder.WebPGetFeatures(buff, buff.length, bitstream);\n  if (status !== 0) {\n    throw new Error('Unable to decode webp image!', status);\n  }\n\n  output_buffer.J = 4;\n  status = decoder.WebPDecode(buff, buff.length, config);\n\n  if (status != 0) {\n    throw new Error('WebP decoding failed.', status);\n  }\n\n  return {\n    bitmap: output_buffer.c.RGBA.ma,\n    height: output_buffer.height,\n    width: output_buffer.width\n  };\n}\n\nvar canvas = document.createElement('canvas');\nvar context = canvas.getContext('2d');\n\nfunction convertWebPToPNG(src) {\n  return loadImage(src).then(function (data) {\n    const webp = convertWebPText(data);\n    canvas.height = webp.height;\n    canvas.width = webp.width;\n\n    var output = context.createImageData(canvas.width, canvas.height);\n    var outputData = output.data;\n\n    for (var h = 0; h < webp.height; h++) {\n      for (var w = 0; w < webp.width; w++) {\n        outputData[0 + w * 4 + webp.width * 4 * h] = webp.bitmap[1 + w * 4 + webp.width * 4 * h];\n        outputData[1 + w * 4 + webp.width * 4 * h] = webp.bitmap[2 + w * 4 + webp.width * 4 * h];\n        outputData[2 + w * 4 + webp.width * 4 * h] = webp.bitmap[3 + w * 4 + webp.width * 4 * h];\n        outputData[3 + w * 4 + webp.width * 4 * h] = webp.bitmap[0 + w * 4 + webp.width * 4 * h];\n      }\n    }\n\n    context.putImageData(output, 0, 0);\n    return canvas.toDataURL();\n  })\n}\n\nconst isWebPSupported = new Promise((resolve) => {\n  var image = new Image();\n  image.onload = () => resolve(image.width === 2 && image.height === 1);\n  image.onerror = () => resolve(false);\n  image.src = 'data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAACyAgCdASoCAAEALmk0mk0iIiIiIgBoSygABc6zbAAA/v56QAAAAA==';\n}).then((isSupported) => {\n  if (isSupported) {\n    return true;\n  }\n\n  return new Promise((resolve) => {\n    require.ensure(['../vendor/libwebp-0.2.0.min'], (require) => {\n      require('../vendor/libwebp-0.2.0.min');\n      resolve(false);\n    });\n  });\n})\n\nfunction convertImage(src) {\n  return isWebPSupported.then((isSupported) => {\n    if (isSupported || !/\\.webp\\?/.test(src)) {\n      return src;\n    }\n\n    return convertWebPToPNG(src);\n  });\n}\n\nexport default memoize(convertImage);\n"]}