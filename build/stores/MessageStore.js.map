{"version":3,"sources":["../../src/stores/MessageStore.js"],"names":[],"mappings":"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","file":"MessageStore.js","sourcesContent":["/*\n * Copyright (C) 2015-2016 Actor LLC. <https://actor.im>\n */\n\nimport Immutable from 'immutable';\nimport { ReduceStore } from 'flux/utils';\nimport Dispatcher from '../dispatcher/ActorAppDispatcher';\nimport { ActionTypes, MessageChangeReason } from '../constants/ActorAppConstants';\n\nconst INITIAL_MESSAGES_COUNT = 20;\nconst MESSAGE_COUNT_STEP = 20;\n\nconst getMessageId = (message) => message ? message.rid : null;\n\nclass MessageStore extends ReduceStore {\n  getInitialState() {\n    return {\n      messages: [],\n      overlay: [],\n      isLoaded: false,\n      isLoading: false,\n      receiveDate: 0,\n      readDate: 0,\n      count: 0,\n      firstMessageId: null,\n      lastMessageId: null,\n      changeReason: MessageChangeReason.UNKNOWN,\n      selected: new Immutable.Set()\n    };\n  }\n\n  getAll() {\n    return this.getState().messages;\n  }\n\n  getRenderMessagesCount() {\n    return this.getState().count;\n  }\n\n  getMessages() {\n    return this.getState().messages;\n  }\n\n  getOverlay() {\n    return this.getState().overlay;\n  }\n\n  isLoaded() {\n    return this.getState().isLoaded;\n  }\n\n  isAllRendered() {\n    const { messages, count } = this.getState();\n    return messages.length === count;\n  }\n\n  getSelected() {\n    return this.getState().selected;\n  }\n\n  reduce (state, action) {\n    switch (action.type) {\n      case ActionTypes.BIND_DIALOG_PEER:\n        return this.getInitialState()\n\n      case ActionTypes.MESSAGES_CHANGED:\n        const firstMessageId = getMessageId(action.messages[0]);\n        const lastMessageId = getMessageId(action.messages[action.messages.length - 1]);\n\n        if (firstMessageId !== state.firstMessageId) {\n          return {\n            ...state,\n            firstMessageId,\n            lastMessageId,\n            messages: action.messages,\n            overlay: action.overlay,\n            receiveDate: action.receiveDate,\n            readDate: action.readDate,\n            isLoaded: action.isLoaded,\n            isLoading: false,\n            count: Math.min(action.messages.length, state.count + MESSAGE_COUNT_STEP),\n            changeReason: MessageChangeReason.UNSHIFT\n          };\n        }\n\n        if (lastMessageId !== state.lastMessageId) {\n          return {\n            ...state,\n            firstMessageId,\n            lastMessageId,\n            messages: action.messages,\n            overlay: action.overlay,\n            receiveDate: action.receiveDate,\n            readDate: action.readDate,\n            isLoaded: action.isLoaded,\n            count: Math.min(action.messages.length, state.count + action.messages.length - state.messages.length),\n            changeReason: MessageChangeReason.PUSH\n          };\n        }\n\n        return {\n          ...state,\n          firstMessageId,\n          lastMessageId,\n          messages: action.messages,\n          overlay: action.overlay,\n          receiveDate: action.receiveDate,\n          readDate: action.readDate,\n          isLoaded: action.isLoaded,\n          count: Math.min(action.messages.length, INITIAL_MESSAGES_COUNT),\n          changeReason: MessageChangeReason.UPDATE\n        };\n\n      case ActionTypes.MESSAGES_LOADING_MORE:\n        return {\n          ...state,\n          isLoading: true\n        };\n\n      case ActionTypes.MESSAGES_LOAD_MORE:\n        return {\n          ...state,\n          count: Math.min(state.messages.length, state.count + MESSAGE_COUNT_STEP),\n          changeReason: MessageChangeReason.UNSHIFT\n        };\n\n      case ActionTypes.MESSAGES_TOGGLE_SELECTED:\n        return {\n          ...state,\n          selected: state.selected.has(action.id) ? state.selected.remove(action.id) : state.selected.add(action.id)\n        };\n\n      default:\n        return state;\n    }\n  }\n}\n\nexport default new MessageStore(Dispatcher);\n"]}