{"version":3,"sources":["../../src/stores/ComposeStore.js"],"names":[],"mappings":"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","file":"ComposeStore.js","sourcesContent":["/*\n * Copyright (C) 2015 Actor LLC. <https://actor.im>\n */\n\nimport { EventEmitter } from 'events';\nimport ActorClient from '../utils/ActorClient';\n\nimport { register, waitFor } from '../dispatcher/ActorAppDispatcher';\n\nimport { ActionTypes, PeerTypes } from '../constants/ActorAppConstants';\n\nimport DraftStore from './DraftStore';\n\nconst CHANGE_EVENT = 'change';\n\nconst getQuery = (text, position) => {\n  const run = (runText, query) => {\n    if (runText.length === 0) {\n      return null;\n    } else {\n      const lastChar = runText.charAt(runText.length - 1);\n      if (lastChar === '@') {\n        const charBeforeAt = runText.charAt(runText.length - 2);\n        if (charBeforeAt.trim() === '') {\n          const text = (query || '');\n          const atStart = text.length + 1 === position;\n\n          return {\n            text: text,\n            atStart: atStart\n          };\n        } else {\n          return null;\n        }\n      } else if (lastChar.trim() === '') {\n        return null;\n      } else {\n        return run(runText.substring(0, runText.length - 1), lastChar + (query || ''));\n      }\n    }\n  };\n\n  const runText = text.substring(0, position);\n  return run(runText, null);\n};\n\nlet text = '';\nlet mentions = null;\n\nclass ComposeStore extends EventEmitter {\n  getMentions() {\n    return mentions;\n  }\n\n  getText() {\n    return text;\n  }\n\n  emitChange() {\n    this.emit(CHANGE_EVENT);\n  }\n\n  addChangeListener(callback) {\n    this.on(CHANGE_EVENT, callback);\n  }\n\n  removeChangeListener(callback) {\n    this.removeListener(CHANGE_EVENT, callback);\n  }\n}\n\nconst ComposeStoreInstance = new ComposeStore();\n\nconst onTyping = (action) => {\n  text = action.text;\n  const query = getQuery(text, action.caretPosition);\n\n  if (action.peer.type === PeerTypes.GROUP && query !== null) {\n    mentions = ActorClient.findMentions(action.peer.id, query.text);\n  } else {\n    mentions = null;\n  }\n\n  ComposeStoreInstance.emitChange();\n};\n\nconst onMentionInsert = (action) => {\n  const query = getQuery(action.text, action.caretPosition);\n  const mentionEnding = query.atStart ? ': ' : ' ';\n\n  text = action.text.substring(0, action.caretPosition - query.text.length - 1) +\n         action.mention.mentionText +\n         mentionEnding +\n         action.text.substring(action.caretPosition, action.text.length);\n\n  mentions = null;\n\n  ComposeStoreInstance.emitChange();\n};\n\nconst onMentionClose = () => {\n  mentions = null;\n  ComposeStoreInstance.emitChange();\n};\n\nconst onComposeClean = () => {\n  text = '';\n  mentions = null;\n  ComposeStoreInstance.emitChange();\n};\n\nconst onSelectDialogPeer = () => {\n  waitFor([DraftStore.dispatchToken]);\n  text = DraftStore.getDraft();\n  ComposeStoreInstance.emitChange();\n};\n\nconst onEmojiInsert = (action) => {\n  const emojiText = `${action.emoji} `;\n\n  text = action.text.substring(0, action.caretPosition) +\n         emojiText +\n         action.text.substring(action.caretPosition, action.text.length);\n\n  ComposeStoreInstance.emitChange();\n};\n\nconst onComposePaste = (newText) => {\n  text = newText;\n  ComposeStoreInstance.emitChange();\n};\n\nComposeStoreInstance.dispatchToken = register(action => {\n  switch (action.type) {\n    case ActionTypes.COMPOSE_TYPING:\n      onTyping(action);\n      break;\n    case ActionTypes.COMPOSE_MENTION_INSERT:\n      onMentionInsert(action);\n      break;\n    case ActionTypes.COMPOSE_MENTION_CLOSE:\n      onMentionClose();\n      break;\n    case ActionTypes.COMPOSE_CLEAN:\n      onComposeClean();\n      break;\n    case ActionTypes.SELECT_DIALOG_PEER:\n      onSelectDialogPeer();\n      break;\n    case ActionTypes.EMOJI_INSERT:\n      onEmojiInsert(action);\n      break;\n    case ActionTypes.COMPOSE_PASTE:\n      onComposePaste(action.text);\n      break;\n    default:\n  }\n});\n\nexport default ComposeStoreInstance;\n"]}